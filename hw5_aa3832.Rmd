---
title: "p8105 hw5"
author:  "Alexey Abramov"
date: "11/15/2020"
output: 
  github_document:
    toc: true
---

# Setup

```{r, setup}
library(tidyverse)
library(readr)
library(rvest)
library(plotly)
library(purrr)
library(stringr)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.height = 6,
  out.width = "90%"
)

theme_set(
  ggthemes::theme_fivethirtyeight() + theme(legend.position = "bottom")
  )

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.colour = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Loading the data.

```{r}
homicide_df = 
  read_csv("homicide_data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",)
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```

# Problem 1

## Summarizing the data to create two new columns for total murders and unsolved murders.  

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

## Performing a prop.test for one city.  

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>%
    pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% 
    pull(hom_total)) %>% 
  broom::tidy()
```

## Now will iterate to the remaining cities.  

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```

## Plotting results

```{r}
homicide_plot = results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(title = "Unsolved Homicides in American Cities")

homicide_plot
```

## Problem 1 -  Describing the data

These homicide data are obtained from an investigative report published in the Washington Post on homicides in 50 American cities.  The article focuses on the cities where murders appear to go unsolved. There are a total of `r nrow(homicide_df)` rows in this dataset. From these data and the accompanying plot titled "Unsolved Homicides in American Cities" we can appreciate that the probability of a homicide going unsolved is highest in Chigago, IL with an estimated 0.73 probability of a murder going unsolved.   

# Problem 2

## Importing one data set 

```{r}
data_1 = read_csv("lda_data/con_01.csv")
```

## Iterating to importing the remaining data... 

```{r}
path_df = 
  tibble(
    path = list.files("lda_data")) %>% 
  mutate(
    path = str_c("lda_data/", path))

read_csv(path_df$path[[1]])
```

## Iterating to add the remaining data

```{r}
path_df = 
  tibble(
    path = list.files("lda_data")) %>% 
  mutate(
    path = str_c("lda_data/", path),
    data = map(path_df$path, read_csv))
```

Checking now to see if this works for one... 

```{r}
path_df$data[[1]]
```

Nice, yes it does!

## Data wrangling, and tidying

```{r}
path_df %>% 
  separate(path, into = c("lda_data", "study_arm"), sep = "/") %>% 
  select(!lda_data) %>% 
  separate(study_arm, into = c("study_arm", "subject"), sep = "_") %>% 
  str_sub(subject, -3)
  
```

